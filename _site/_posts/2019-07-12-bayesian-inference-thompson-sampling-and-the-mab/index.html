<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/css/reset.css" type="text/css">
    <link rel="stylesheet" href="/css/vars.css" type="text/css">
    <link rel="stylesheet" href="/css/base.css" type="text/css">

    <!-- sidebar -->
    <link rel="stylesheet" href="/css/nav.css" type="text/css">

    <!-- syntax highlighting -->
    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">

    <!-- font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;1,100;1,300&display=swap" rel="stylesheet"> 

    <!-- Dark mode : script 1 of 2-->
    <script src="/css/dark_mode_init.js"></script>

    <title>The beta-Bernoulli bandit, Thompson sampling, and Bayesian inference</title>
  </head>
  <body>

    <div class = "container">
      <div class = "header">
      </div>

      <div class = "body">
      <div class = "sidebar">
      <link rel="stylesheet" href="/css/nav.css" type="text/css">

<!-- Switch for dark mode toggle -->
<link rel="stylesheet" href="/css/switch.css" type="text/css">

<div>
 <a class = "page-title" href = "/"> 劉 </a>
 <span class = "page-subtitle"> Lieu Zheng Hong </span>
</div>


<hr>


<ul class = "navlist">
    <li> <a href="/"> Home </a> </li>
    <li> <a href="/about"> About </a> </li>
    <li> <a href="/projects"> Projects </a> </li>
    <li> <a href="/archive"> Archive </a> </li>
    <li> <a href="/ppe-stuff"> PPE work </li>
    <li> <a href="/notes"> Notes </a> </li>
</ul>

<hr>


<div class = "dark-mode-toggle-area">

  dark mode:
  <label id="theme-switch" class="theme-switch" for="checkbox_theme">
  <input type="checkbox" id="checkbox_theme" class="switch">
  <span class="slider"></span>
  </label>

</div>

      </div>

      <div class = "content-wrapper">
        <div class = "content">
          <h1> The beta-Bernoulli bandit, Thompson sampling, and Bayesian inference </h1>
          <p>I'm using the work I do at my internship to run a behavioural economics
experiment. Trying to run this experiment has led me down an incredibly deep
rabbit hole, and I wanted to write down some of the things I've learned before
I inevitably forget.</p>
<p>I also wanted to use this blog post to defend many of the decision points I
made---there were many points where I had to make a decision to use one
approach or another, and I spent many hours thinking and reading about the best
approach.</p>
<hr>
<h2>Background</h2>
<p>I'm trying to send SMSes to customers telling them to install an app.
Behavioural economics predicts that people are loss-averse, so I am trying to
find out if sending SMSes that have a loss-aversion framing</p>
<blockquote>
<p>&quot;install the app
now, or you'll lose your 4500THB cashback&quot;</p>
</blockquote>
<p>has a greater effect than sending
SMSes that have a positive framing</p>
<blockquote>
<p>&quot;install the app now, to get 4500THB
cashback&quot;</p>
</blockquote>
<p>The question is:</p>
<p><strong>How can we find out which SMS is best?</strong></p>
<p>The gold standard of causal inference is to do a randomised experiment:
randomly divide my 2400 participants into groups of 800 each, then send 800 the
neutral (control), 800 the positive, and 800 the negative. Record the number of
successes (clicked SMS) and failures (did not click SMS) for each treatment.</p>
<p>By the Central Limit Theorem all of these will be normal distributions. We can
then do the usual t-tests/chi-squared test and test that there is a
statistically significant difference between the means. (More precisely, we
reject the null hypothesis that there is no difference between the means).</p>
<p>This is Good and Rigorous™ — but the problem is nobody is going to let you run
it because this is leaving money on the table. Only 800 customers are going to
get the optimal treatment, but that means 2/3rds of them will be getting a
suboptimal treatment.</p>
<p>Is there a better way? Specifically, is there an optimal way to send the SMSes
so that we can &quot;know&quot; which treatment is best with some notion of certainty,
yet still get the most number of people receiving the optimal treatment at the
end of the day?</p>
<p><strong>Why this can be modelled as a multi-armed bandit problem</strong></p>
<p>It turns out that this is an incredibly-well-studied field, with a lot of applications everywhere from medical trials to (of course) marketing.</p>
<p>The explanation of the multi-armed bandit is incredibly intuitive, and it's
something you just grok the instant you hear about it.</p>
<blockquote>
<p>You are walking around the casino floor where there are ten slot machines,
each with a different probability of paying out. How should one pull the slot
machines in order to maximise one's payout over the long run?</p>
</blockquote>
<p>There are two tradeoffs here. On the one hand, we want to <em>explore</em> in order to
find out what the best slot machine is. The best way to be sure of what the
actual probabilities of the payouts are is to pull every arm equally.</p>
<p>But on the other hand, do we really <em>care</em> about what the actual probabilities
of <em>all</em> the payouts are? Does it really matter if slot machine #4 could have
a probability of 0.01--0.03 if we are pretty sure that slot machine #5 has a
probability of 0.40-0.60? Fundamentally we want to <em>exploit</em>: if we are already
90% sure that this slot machine is the best one, we shouldn't keep pulling the
others to &quot;explore&quot;, because that will in expectation reduce our earnings.
<a href="https://lilianweng.github.io/lil-log/2018/01/23/the-multi-armed-bandit-problem-and-its-solutions.html#bandit-strategies">This
post</a>
was incredibly helpful for getting the intuitions, and I'll refer to this post
again and again.</p>
<p>In the same way, it's suboptimal^[1] to run a &quot;pure exploration strategy&quot; of
800/800/800 split. Once we've made, say, 100 pulls each, we should be more or
less &quot;sure enough&quot; about the probability of each treatment, and therefore we
should &quot;shift gears&quot; and start the exploitation.</p>
<p>^[1]: Here I should clarify --- suboptimal <em>for what</em>? For a scientific
experiment where the goal is to discover a fact about the world, then we
shouldn't care about exploitation at all. We want the highest possible
statistical power, and that means maximising exploration. But of course in this
case where money is on the line, some balance of exploration and exploitation
must be struck.</p>
<hr>
<p>OK, so now I've shown that if we want to maximise our payout (also called the
&quot;cumulative reward&quot;), then a pure exploratory strategy is suboptimal. That
leads to a very natural follow-up question:</p>
<p><strong>What is the optimal strategy to maximise cumulative reward?</strong></p>
<p>Now that we have intuition firmly in our heads, it is useful at this point to
introduce some mathematics so that we can more formally specify the problem.</p>
<p>I'll not focus here on the general multi-armed bandit (MAB) problem. Instead
I'll specify the Bernoulli bandit, and I'll modify slightly the description
from <a href="https://web.stanford.edu/~bvr/pubs/TS_Tutorial.pdf">this paper</a></p>
<blockquote>
<p><em>(Bernoulli Bandit)</em> Suppose there are $$K$$ actions and $$T$$ time-steps,
and when an action is played, it yields either a success or a failure. Action
$$k \in {1, ..., K}$$ produces a success with probability $$\theta_k \in
[0,1]$$. If there is a success, then $$r_t = 1$$, else $$r_t = 0$$. The
success probabilities are unknown to the agent, but are fixed over time. The
objective is to maximise the cumulative reward $$\sum^T_{t=1} r_t$$ over
$$T$$ periods, where $$T$$ is relatively large compared to the number of arms
$$K$$.</p>
</blockquote>
<p>Let's first think about a few simple strategies. Let's start with the worst:</p>
<ol>
<li>Random -- choose an arm at random every period.</li>
</ol>
<p>Both of these approaches are pretty bad.</p>
<p>First of all, the random strategy is exactly that---random---and the expected
cumulative reward for this strategy is simply</p>
<p>$$\sum^K_{k=1} \frac{T}{3} \theta_k$$</p>
<p>for instance, if $$\theta = {0.3, 0.4, 0.5}$$ and $$T=300$$, then the random
strategy would give $$\mathbb{E}[r] = 30 + 40 + 50 = 120$$.</p>
<p>Notice that the Random strategy is exactly the &quot;random assignment&quot; algorithm of
assigning 800/800/800.</p>
<p>Can we do better? Let's try the following:</p>
<ol start="2">
<li>&quot;Dumb&quot; Greedy(N) -- pull each arm N times. Pick the arm with the highest sampled
$$\theta$$; call it arm $$K*$$. Then always pull arm $$K*$$ henceforth.</li>
</ol>
<p>Note the two degenerate cases: if $$N=0$$, Dumb Greedy picks an arm at random
and pulls it all the way. If $$N=T/K$$, the greedy approach reduces to the
random strategy. For intermediate values of N,  we <em>first</em> pull all arms N
times, to get a better idea of the distribution, then checks the best arm and
pulls that. Greedy(N) dominates random choice, because it
gets <em>some</em> information about which arm is best, and uses that information to
inform its choice.</p>
<p>This strategy's effectiveness follows a U-shaped curve: it's no better than
random choice if you just pick a random arm at t=0 and pull it forever, or
forever pick a random arm. By the law of large numbers, the more you pull, the
more certain you are about the true means of the arms, but the less time you
have to pull the best arm. This captures our intuition of exploring and
exploiting: the knowledge you gain from exploring is good, but only if you
manage to exploit that knowledge.</p>
<p><em>TODO (questions for author): How much better is Greedy(N) than random? What is the optimal N?</em></p>
<p>It would be good if we had some measure of not just the mean, but also how
<em>certain</em> we were of our estimate of the mean. If I flip a coin 10 times and get
1 head and 9 tails, I am much less certain of its fairness as if I were to flip
that coin 500 times and get 50 heads and 450 tails.</p>
<p>It turns out that measure does exist, and it's called ...</p>
<p><strong>The beta distribution</strong></p>
<p>The beta distribution can best be thought of as &quot;a distribution of probabilities
--- that is, it represents all the possible values of a probability when we
don't know what that probability is.&quot;</p>
<p><a href="https://stats.stackexchange.com/questions/47771/what-is-the-intuition-behind-beta-distribution">This Stats.SE thread entitled &quot;What is the intuition behind beta
distribution&quot;</a>
has loads of fantastic answers, and it's where I got that explanation from. I
would certainly recommend reading through David Robinson's answer.</p>
<p>Here's how I would explain it:</p>
<p>We know that the treatments are Bernoulli with parameter $$p$$. Then in $$N$$
repeated trials the treatments must follow a binomial distribution with $$B(N,
p)$$.</p>
<p>Suppose we conduct N trials and observe $$\alpha$$ successes and $$\beta$$
failures. Then the beta distribution $$Beta(\alpha+1, \beta+1)$$ gives us the
<em>range</em> of &quot;reasonable estimates&quot; of the binomial distribution parameter $$p$$.</p>
<p><img src="/img/thompson-sampling/beta_distribution_1.png" alt=""></p>
<p>This image by Raffael Vogler very nicely shows why a beta distribution gives us
what we want. We wanted a measure of the mean but also a measure of our
certainty that the mean is what we think it is. Here we can see that while the
orange curve has a higher mean (0.9), our &quot;best estimate&quot; of its true value is
quite diffuse. On the other hand, we're quite sure that true value of the
second curve (in yellow) lies close to 0.8.</p>
<p>Furthermore, the beta distribution has a lovely property in that we can
&quot;update&quot; the beta distribution very easily as we get more data. Suppose we have
2 heads and 8 tails: the beta distribution is $$Beta(3, 9)$$. We flip the coin
again. It comes up heads. Then the beta distribution easily updates to
$$Beta(4,10)$$.</p>
<p>Armed with this knowledge of beta-distributions, we can try the following strategy.</p>
<p>Can we do better? Let's try the following:</p>
<ol>
<li>&quot;Smart&quot; beta-Greedy: At every time step, calculate $$\hat{\theta}$$ of every arm,
then pull the arm with the highest $$\hat{\theta}$$ and update the
$$\hat{\theta}$$ according to the result.</li>
</ol>
<p>How &quot;Smart&quot; beta-Greedy works: Initialise each arm with $$\hat{\theta} =
\mathbb{E}[Beta(1, 1)] = 0.5$$. The Beta(1,1) distribution is a uniform
distribution over [0,1], and is what's known as an <em>uninformative prior</em>: we
assume that all rewards are equally likely.</p>
<p>At the start, seeing that all thetas are equal, we pull an arm at random; call this
arm $$k$$. We update $$\hat{\theta_k}$$ appropriately</p>
<p>We update as follows:</p>
<ul>
<li>If we do get a reward: $$(\alpha_k, \beta_k) = (\alpha_k+1, \beta)$$</li>
<li>If we do not get a reward: $$(\alpha_k, \beta_k) = (\alpha_k, \beta+1)$$</li>
</ul>
<p>Finally, pick the best $$\hat{\theta}$$, which is given by
$$\frac{\alpha_k}{(\alpha_k + \beta_k}$$. Repeat this process.</p>
<p>This greedy algorithm is smarter than &quot;dumb&quot; greedy, because it constantly
reevaluates what the best arm is with our new beta updating rule. This is
pretty good, right?</p>
<p><em>Can we do better?</em></p>
<p>Take a look at this image from <em>A Tutorial on Thompson Sampling</em>.</p>
<p><img src="/img/thompson-sampling/beta_distribution_2.png" alt=""></p>
<p>There are three possible arms. The greedy algorithm would always choose action
1, because action 1 has the maximal expected mean reward. &quot;Since the
uncertainty around this expected mean reward is small, observations are
unlikely to change the expectation substantially, and therefore, action 1 is
likely to be selected <em>ad ininitum</em>.&quot;</p>
<p>It seems reasonable to avoid action 2, since it is extremely unlikely that
$$\theta_2 &gt; \theta_1$$, but the algorithm should try out $$\theta_3$$, because
if you take a look at that distribution in red it's quite plausible that its
mean reward exceeds 0.6. &quot;The algorithm fails to account for uncertainty in the
mean reward of action 3, which should entice the agent to explore and learn
about that action.&quot; (p. 10-11)</p>
<p>Let's try and capture some intuition here. The problem with &quot;Smart&quot; Greedy is
that it can be misled by an initial lucky or unlucky streak, and get stuck in a
suboptimal maxima of exploitation. We could modify &quot;Smart&quot; Greedy to pull every
arm N times first, just like &quot;Dumb&quot; Greedy(N), but here's another way to do it:</p>
<ol>
<li>ε-Greedy -- like &quot;Smart&quot; Greedy, but with probability $$\epsilon$$ pull an
arm at random.</li>
</ol>
<p>The ε-greedy algorithm takes the best action most of the time, but does random
exploration occasionally. This will prevent the algorithm from getting &quot;stuck&quot;
on a local optima: 5% of the time it will try action 3, for instance, and learn
more about it. Eventually the ε-greedy algorithm will converge onto the best
action.</p>
<p><em>TODO (questions for author): How good is ε-Greedy compared to Smart Greedy?</em></p>
<p>But again ε-greedy is not optimal for two reasons. First, if we're already dead
certain about the best lever, we don't want it to pull a random bad lever ε of
the time! Second of all, it wastes pulls exploring arms we're already certain
about. In this case we want to explore action 3, and we don't want to explore
action 1 at all. Yet the ε-greedy algorithm will select action 1 and 3 with
equal probability.</p>
<p>This is suboptimal. We need something that intelligently allocates exploratory
effort: go where your estimates are the most uncertain. Can we do better?
Enter...</p>
<p><strong>Thompson sampling</strong></p>
<p>Thompson sampling is a very subtle modification of the &quot;smart&quot; greedy
algorithm: so subtle, in fact, that I missed it the first time! Here's the
difference: instead of choosing the highest expected theta value, <em>sample</em> the
theta values from the beta distributions.</p>
<p>Take a look at the image again:</p>
<p><img src="/img/thompson-sampling/beta_distribution_2.png" alt=""></p>
<p>The expected rewards are $$\theta = [0.6, 0.4, 0.4]$$. The greedy algorithm
selects the action with the highest expected reward: that is, action 1.
Thompson sampling <em>samples</em> from the beta distributions: in other words,</p>
<p>$$\hat{\theta_k} \sim Beta(\alpha_k, \beta_k)$$. It then pulls the arm with the
maximum sampled reward.</p>
<p>This is genius! Why? Consider a typical sample. Sampling action 1 will give us
a value very close to 0.6. Sampling action 2 will give us a value very close to
0.4. Sampling action 3, on the other hand, will give us a wide range of values,
<em>including</em> values greater than 0.6. This means that action 2 will pretty much
never be chosen, but there's a good chance of action 3 being chosen! In other
words --- Thompson sampling nicely directs exploration effort towards the
unknown.</p>
<p>I ran 10,000 simulations, and here are the results...</p>
<p><strong>Bayesian inference vs frequentist inference</strong></p>
<p>Once I have the results ....</p>
<p>I can use <a href="https://en.wikipedia.org/wiki/Fisher's_exact_test">Fisher's exact
test</a> or the normal approximation to the binomial distribution.</p>
<p>By the CLT, we know that all three treatments must be normally distributed.</p>
<p>Bayesian inference: there is a closed form, but I can use simulation to compare
the three beta distributions:</p>
<p><a href="https://mathoverflow.net/q/90361">Given several beta distributions, what is the probability that one is the
highest?</a></p>
<p>A paper from NIPS 2011 (&quot;An empirical evaluation of Thompson Sampling&quot;) shows, in experiments, that Thompson Sampling beats UCB. UCB is based on choosing the lever that promises the highest reward under optimistic assumptions (i.e. the variance of your estimate of the expected reward is high, therefore you pull levers that you don't know that well). Instead, Thompson Sampling is fully Bayesian: it generates a bandit configuration (i.e. a vector of expected rewards) from a posterior distribution, and then acts as if this was the true configuration (i.e. it pulls the lever with the highest expected reward).  ^[1]</p>
<p>^[1]: Pedro A. Ortega (https://stats.stackexchange.com/users/9572/pedro-a-ortega), Best bandit algorithm?, URL (version: 2017-03-24): https://stats.stackexchange.com/q/24027</p>
<p>Call the different SMS treatments A, B, and C, and the probability of someone
installing the app $$r$$ can be conditional on either one of these treatments.
The <em>value</em> of each treatment $$Q(\cdot)$$ is the expected reward given that
treatment, $$Q(A) = \mathbb{E}[r|A]$$.</p>
<p><strong>A little wrinkle</strong></p>
<p><a href="https://www.evanmiller.org/bayesian-ab-testing.html#notes">Formulas for Bayesian A/B Testing</a></p>
<p>Why do I use Bayesian methods?</p>
<ul>
<li>Frequentist approaches require me to set sample size for adequate power, and
this sample size depends on effect size. But I have no good prior for effect
size</li>
<li>Sample size large</li>
</ul>
<p><strong>Contextual bandits</strong></p>
<p>Agarwal 2013 <a href="http://proceedings.mlr.press/v28/agrawal13.pdf">Thompson Sampling for Contextual Bandits with Linear
Payoffs</a></p>
<p><strong>Top-two Thompson Sampling for Best-Arm Identification</strong></p>
<p><a href="https://arxiv.org/pdf/1602.08448.pdf">Simple Bayesian Algorithms for Best-Arm Identification</a></p>
<p>Now suppose we have</p>

        <div>
      </div>

      <div class = "footer">
      </div>

    <div>


    </div>

    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!--Dark mode toggle -->
    <script src="/css/dark_mode_toggle.js"></script>

  </body>
</html>
